â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ… UPDATE AGENT v1.1.0 - READY FOR DEPLOYMENT âœ…             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ OVERVIEW

The OPNManager Update Agent is a FAILSAFE agent that:
  â€¢ Monitors the primary agent health
  â€¢ Can download and install new primary agent versions
  â€¢ Automatically restarts crashed primary agents
  â€¢ Checks in every 30 minutes (low overhead)
  â€¢ CANNOT be updated remotely (manual SSH only - for safety)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ COMPLETED TASKS                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Update Agent Script Improvements (v1.0 â†’ v1.1.0)
   â€¢ Added PID locking (MUST BE FIRST - like Agent v3.1.0)
   â€¢ Explicit binary paths for FreeBSD compatibility
   â€¢ Inline JSON format (no heredocs)
   â€¢ Proper error handling and logging
   â€¢ Changed check-in interval: 5 min â†’ 30 min (1800 seconds)
   â€¢ Added trap for PID cleanup on exit
   â€¢ Improved logging with timestamps to /var/log/opnsense_update_agent.log

âœ… Database Schema Fixed
   â€¢ Removed single-column UNIQUE key on firewall_id
   â€¢ Kept composite UNIQUE key (firewall_id, agent_type)
   â€¢ Now allows both 'primary' and 'update' agents per firewall

âœ… Built-in Deployment System Created
   â€¢ deploy_update_agent.php - Queues deployment via command queue
   â€¢ Uses existing primary agent to deploy update agent
   â€¢ Verifies primary agent is online before deploying
   â€¢ Prevents duplicate deployments
   â€¢ Automatic installation of:
     - Agent script to /usr/local/bin/opnsense_update_agent.sh
     - rc.d service file /usr/local/etc/rc.d/opnsense_update_agent
     - Auto-enable and start service

âœ… UI Integration
   â€¢ Added "Deploy Update Agent" button to firewall_details.php
   â€¢ Shows deployment status (Not Deployed / Online)
   â€¢ One-click deployment with confirmation dialog
   â€¢ Automatic page reload after successful deployment

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ FILES MODIFIED/CREATED                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. /var/www/opnsense/opnsense_update_agent.sh
   â€¢ Upgraded from v1.0.0 to v1.1.0
   â€¢ 8.2 KB (was 4.3 KB)
   â€¢ PID locking, explicit paths, inline JSON
   â€¢ Check-in interval: 1800 seconds (30 minutes)

2. /var/www/opnsense/deploy_update_agent.php (NEW)
   â€¢ PHP endpoint to queue update agent deployment
   â€¢ Validates firewall exists and primary agent is online
   â€¢ Builds deployment script dynamically
   â€¢ Inserts command into firewall_commands queue

3. /var/www/opnsense/firewall_details.php
   â€¢ Added "Deploy Update Agent" button in UI
   â€¢ Added deployUpdateAgent() JavaScript function
   â€¢ Shows "Not Deployed" vs "Online" status

4. /var/www/opnsense/inc/version.php
   â€¢ UPDATE_AGENT_VERSION: '1.0.0' â†’ '1.1.0'
   â€¢ UPDATE_AGENT_STATUS: 'Not Deployed' â†’ 'Ready for Deployment'

5. /var/www/opnsense/download_update_agent.php (existing)
   â€¢ Already working - serves agent script to firewalls
   â€¢ Replaces __FIREWALL_ID__ placeholder

6. Database: firewall_agents table
   â€¢ Dropped UNIQUE KEY unique_firewall (firewall_id)
   â€¢ Kept UNIQUE KEY firewall_agent_type (firewall_id, agent_type)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ HOW TO DEPLOY UPDATE AGENT                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Method 1: Via UI (Recommended)
  1. Go to firewall details page
  2. Look for "Update Agent" section showing "Not Deployed"
  3. Click "Deploy Update Agent" button
  4. Confirm the deployment dialog
  5. Wait for primary agent to execute (within 120 seconds)
  6. Page will auto-reload showing update agent online

Method 2: Via API
  curl -X POST https://opn.agit8or.net/deploy_update_agent.php \
    -d "firewall_id=21" \
    -H "Cookie: PHPSESSID=your_session"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ UPDATE AGENT BEHAVIOR                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š Normal Operation:
  â€¢ Checks in every 30 minutes (1800 seconds)
  â€¢ Reports: firewall_id, agent_version, agent_type, hostname, uptime
  â€¢ Monitors primary agent health
  â€¢ Auto-restarts primary agent if crashed

ğŸ”„ Update Flow (when commanded):
  1. Receives "update_primary":true in check-in response
  2. Downloads new primary agent from download_url
  3. Validates it's a valid shell script
  4. Backs up old primary agent
  5. Installs new primary agent
  6. Kills old primary agent process
  7. Starts new primary agent
  8. Reports success/failure back to server

ğŸš¨ Health Monitoring:
  â€¢ Every check-in, verifies primary agent is running
  â€¢ If primary agent dead, automatically restarts it
  â€¢ Logs all actions to /var/log/opnsense_update_agent.log

ğŸ”’ Safety Features:
  â€¢ PID locking prevents duplicate instances
  â€¢ Cannot be killed via command queue (failsafe)
  â€¢ Manual SSH access required to update update agent
  â€¢ Validates downloads before installing

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ TESTING CHECKLIST                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ready to test on Firewall ID 21 (home.agit8or.net):

â–¡ Deploy update agent via UI button
â–¡ Verify command queued in firewall_commands table
â–¡ Wait 120 seconds for primary agent to execute
â–¡ Check system_logs for deployment status
â–¡ Verify update agent appears in firewall_agents table
â–¡ Verify update agent shows "Online" in UI
â–¡ Check update agent PID: ls -l /var/run/opnsense_update_agent.pid
â–¡ Check update agent log: tail -f /var/log/opnsense_update_agent.log
â–¡ Verify check-in every 30 minutes
â–¡ Test primary agent crash recovery (kill primary agent)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ TECHNICAL DETAILS                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Check-in Intervals:
  Primary Agent:  120 seconds (2 minutes)
  Update Agent:   1800 seconds (30 minutes)

Paths:
  Primary Agent:  /usr/local/bin/opnsense_agent.sh
  Update Agent:   /usr/local/bin/opnsense_update_agent.sh
  Primary PID:    /var/run/opnsense_agent.pid
  Update PID:     /var/run/opnsense_update_agent.pid
  Update Log:     /var/log/opnsense_update_agent.log

rc.d Services:
  Primary:  /usr/local/etc/rc.d/opnsense_agent
  Update:   /usr/local/etc/rc.d/opnsense_update_agent

Database:
  Table: firewall_agents
  agent_type: 'primary' or 'update'
  Composite UNIQUE key: (firewall_id, agent_type)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ NEXT STEPS                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Test deployment on firewall ID 21
2. Verify check-ins working
3. Implement agent update command UI
4. Test full update flow (deploy new primary agent version)
5. Document update procedures
6. Roll out to production firewalls

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸš€ READY FOR TESTING! ğŸš€                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Version: Update Agent v1.1.0
Status: Ready for Deployment
Date: 2025-10-09
