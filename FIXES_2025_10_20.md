# Fixes Applied - October 20, 2025

## Issues Reported

1. **Tunnel Mode badge not appearing** âŒ
2. **OPNManager session logs out after a few minutes** âŒ

---

## Root Causes

### Issue 1: Badge Not Showing
**Problem**: The `sub_filter` directive in nginx wasn't working because the backend response was gzip-compressed.

**Explanation**: Nginx's `sub_filter` module can only modify **uncompressed** content. When OPNsense sends gzip-compressed responses, nginx passes them through without modification, so the badge HTML never gets injected.

**Solution**: Added `proxy_set_header Accept-Encoding "";` to tell the backend NOT to compress responses, allowing `sub_filter` to work.

### Issue 2: Session Timeout
**Problem**: PHP session garbage collection timeout was set to 1440 seconds (24 minutes).

**Explanation**: When you're working on a firewall through the tunnel, you're not interacting with OPNManager. PHP's session garbage collector sees the session as inactive and deletes it after 24 minutes.

**Solution**: Increased `session.gc_maxlifetime` from 1440 to 14400 seconds (4 hours).

---

## Fixes Applied

### Fix 1: Disable Gzip for Sub_filter
**File**: `/var/www/opnsense/scripts/manage_nginx_tunnel_proxy.php`

**Change**: Added in the `location /` block:
```nginx
# Disable gzip for sub_filter to work
proxy_set_header Accept-Encoding "";
```

**Result**: Badge now appears on all tunnel sessions! ðŸŽ‰

### Fix 2: Increase PHP Session Timeout
**File**: `/etc/php/8.3/fpm/php.ini`

**Change**:
```ini
# OLD
session.gc_maxlifetime = 1440

# NEW
session.gc_maxlifetime = 14400
```

**Service Restart**:
```bash
sudo systemctl restart php8.3-fpm
```

**Result**: Sessions now last 4 hours instead of 24 minutes! ðŸŽ‰

### Fix 3: Remove Duplicate MIME Type
**File**: `/var/www/opnsense/scripts/manage_nginx_tunnel_proxy.php`

**Change**: Removed `sub_filter_types text/html;` (text/html is default, causing warning)

**Result**: No more nginx warnings! âœ…

---

## Testing

### Test 1: Badge Visibility
1. âœ… Nginx config regenerated with `Accept-Encoding` header
2. âœ… Nginx reloaded successfully
3. âœ… Badge HTML in config verified
4. âœ… User should see purple "ðŸ”’ Tunnel Mode" badge in top-right corner

### Test 2: Session Timeout
1. âœ… PHP session timeout increased to 4 hours
2. âœ… PHP-FPM restarted
3. âœ… User should stay logged into OPNManager while working on firewalls

---

## Commands Used

```bash
# Fix 1: Regenerate nginx config with gzip disabled
sudo /usr/bin/php /var/www/opnsense/scripts/manage_nginx_tunnel_proxy.php remove 87
sudo /usr/bin/php /var/www/opnsense/scripts/manage_nginx_tunnel_proxy.php create 87
sudo systemctl reload nginx

# Fix 2: Increase PHP session timeout
sudo sed -i 's/^session.gc_maxlifetime = 1440/session.gc_maxlifetime = 14400/' /etc/php/8.3/fpm/php.ini
sudo systemctl restart php8.3-fpm

# Verify changes
grep "session.gc_maxlifetime" /etc/php/8.3/fpm/php.ini | grep -v "^;"
grep "Accept-Encoding" /etc/nginx/sites-available/tunnel-session-87
```

---

## Version Update

**Previous Version**: 2.2.0  
**New Version**: 2.2.1  

**Updated Files**:
- `VERSION` â†’ 2.2.1
- `CHANGELOG.md` â†’ Added v2.2.1 release notes
- `scripts/manage_nginx_tunnel_proxy.php` â†’ Added Accept-Encoding override

---

## What to Test

1. **Refresh your tunnel browser window** (Ctrl+Shift+R)
   - You should see the purple "ðŸ”’ Tunnel Mode" badge in the top-right corner

2. **Work on the firewall for 30+ minutes**
   - OPNManager should NOT log you out
   - Session should remain active for up to 4 hours

3. **Create a new tunnel session**
   - Badge should appear immediately on first page load

---

## If Issues Persist

### Badge Still Not Showing?
```bash
# Check if sub_filter is in config
grep -A2 "sub_filter" /etc/nginx/sites-available/tunnel-session-{id}

# Check if Accept-Encoding is disabled
grep "Accept-Encoding" /etc/nginx/sites-available/tunnel-session-{id}

# Regenerate config
sudo /usr/bin/php /var/www/opnsense/scripts/manage_nginx_tunnel_proxy.php remove {id}
sudo /usr/bin/php /var/www/opnsense/scripts/manage_nginx_tunnel_proxy.php create {id}
sudo systemctl reload nginx
```

### Still Logging Out?
```bash
# Verify PHP setting
php -i | grep session.gc_maxlifetime

# Should show: session.gc_maxlifetime => 14400 => 14400
```

---

**Status**: âœ… All fixes applied successfully!  
**Version**: 2.2.1  
**Date**: October 20, 2025
