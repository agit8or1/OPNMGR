#!/bin/bash

# OPNsense Management Agent v2.0
# Enhanced agent with command processing and auto-update capability

AGENT_VERSION="2.0"
SCRIPT_PATH="/usr/local/bin/opnsense_agent_v2.sh"
CONFIG_FILE="/usr/local/etc/opnsense_agent.conf"
LOCK_FILE="/tmp/opnsense_agent.lock"
LOG_FILE="/var/log/opnsense_agent.log"

# Default configuration
FIREWALL_ID=""
MANAGEMENT_SERVER="https://opn.agit8or.net"
API_KEY=""
CHECKIN_INTERVAL=300

# Hardware ID generation (persistent)
HARDWARE_ID_FILE="/tmp/opnsense_hardware_id"
if [ ! -f "$HARDWARE_ID_FILE" ]; then
    # Generate unique hardware ID based on system characteristics
    HARDWARE_ID=$(echo "$(hostname)-$(ifconfig | grep -E "ether|lladdr" | head -1 | awk '{print $2}')-$(sysctl -n kern.hostid)" | sha256 | cut -c1-32)
    echo "$HARDWARE_ID" > "$HARDWARE_ID_FILE"
else
    HARDWARE_ID=$(cat "$HARDWARE_ID_FILE")
fi

# Load configuration if exists
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Logging function
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

# Check if script is already running
if [ -f "$LOCK_FILE" ]; then
    if kill -0 $(cat "$LOCK_FILE") 2>/dev/null; then
        log_message "Agent already running (PID: $(cat $LOCK_FILE))"
        exit 1
    else
        rm -f "$LOCK_FILE"
    fi
fi

# Create lock file
echo $$ > "$LOCK_FILE"

# Cleanup on exit
cleanup() {
    rm -f "$LOCK_FILE"
}
trap cleanup EXIT

# Self-install function
install_agent() {
    log_message "Installing OPNsense agent..."
    
    # Copy script to proper location
    cp "$0" "$SCRIPT_PATH"
    chmod +x "$SCRIPT_PATH"
    
    # Create config file if it doesn't exist
    if [ ! -f "$CONFIG_FILE" ]; then
        cat > "$CONFIG_FILE" << EOF
FIREWALL_ID="$HARDWARE_ID"
MANAGEMENT_SERVER="https://opn.agit8or.net"
API_KEY=""
CHECKIN_INTERVAL=300
EOF
    fi
    
    # Add to cron if not already there
    if ! crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"; then
        (crontab -l 2>/dev/null; echo "*/5 * * * * $SCRIPT_PATH >/dev/null 2>&1") | crontab -
        log_message "Added cron job for 5-minute check-ins"
    fi
    
    log_message "Agent installation complete"
    
    # Perform initial check-in
    checkin
    exit 0
}

# Get system information
get_system_info() {
    # Get OPNsense version
    if [ -f /usr/local/opnsense/version/opnsense ]; then
        OPNSENSE_VERSION=$(cat /usr/local/opnsense/version/opnsense)
    else
        OPNSENSE_VERSION="Unknown"
    fi
    
    # Get WAN IP (try multiple methods)
    WAN_IP=""
    # Method 1: Try common WAN interface
    WAN_IP=$(ifconfig em0 2>/dev/null | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | head -1)
    
    if [ -z "$WAN_IP" ]; then
        # Method 2: Try other common interfaces
        for iface in igb0 re0 rl0 bce0; do
            WAN_IP=$(ifconfig $iface 2>/dev/null | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | head -1)
            [ -n "$WAN_IP" ] && break
        done
    fi
    
    if [ -z "$WAN_IP" ]; then
        # Method 3: Get default route interface
        DEFAULT_IF=$(route -n get default 2>/dev/null | grep interface | awk '{print $2}')
        if [ -n "$DEFAULT_IF" ]; then
            WAN_IP=$(ifconfig $DEFAULT_IF 2>/dev/null | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | head -1)
        fi
    fi
    
    # Method 4: Fallback to external IP detection
    if [ -z "$WAN_IP" ]; then
        WAN_IP=$(fetch -qo - http://ipinfo.io/ip 2>/dev/null || curl -s http://ipinfo.io/ip 2>/dev/null || echo "Unknown")
    fi
    
    # Get hostname
    HOSTNAME=$(hostname)
    
    # Create JSON data
    JSON_DATA="{\"hardware_id\":\"$HARDWARE_ID\",\"hostname\":\"$HOSTNAME\",\"ip_address\":\"$WAN_IP\",\"opnsense_version\":\"$OPNSENSE_VERSION\",\"agent_version\":\"$AGENT_VERSION\"}"
}

# Check for pending commands
check_commands() {
    if [ -n "$FIREWALL_ID" ]; then
        log_message "Checking for pending commands..."
        COMMANDS=$(fetch -qo - "${MANAGEMENT_SERVER}/agent_checkin.php" \
            --post-data "firewall_id=${FIREWALL_ID}&action=get_commands" 2>/dev/null)
        
        if [ -n "$COMMANDS" ] && [ "$COMMANDS" != "[]" ]; then
            log_message "Received commands: $COMMANDS"
            process_commands "$COMMANDS"
        fi
    fi
}

# Process commands
process_commands() {
    local commands="$1"
    echo "$commands" | while read -r cmd; do
        if echo "$cmd" | grep -q "firmware_update"; then
            log_message "Processing firmware update command"
            execute_firmware_update
        elif echo "$cmd" | grep -q "agent_update"; then
            log_message "Processing agent update command"
            execute_agent_update
        fi
    done
}

# Execute firmware update
execute_firmware_update() {
    log_message "Starting firmware update..."
    
    # Report command execution start
    if [ -n "$FIREWALL_ID" ]; then
        fetch -qo /dev/null "${MANAGEMENT_SERVER}/command_result.php" \
            --post-data "firewall_id=${FIREWALL_ID}&command=firmware_update&status=executing&result=Starting firmware update" 2>/dev/null
    fi
    
    # Perform the update
    /usr/local/etc/rc.firmware update > /tmp/firmware_update.log 2>&1
    UPDATE_RESULT=$?
    
    # Report result
    if [ $UPDATE_RESULT -eq 0 ]; then
        RESULT="Firmware update completed successfully"
        STATUS="completed"
    else
        RESULT="Firmware update failed: $(tail -5 /tmp/firmware_update.log)"
        STATUS="failed"
    fi
    
    log_message "$RESULT"
    
    if [ -n "$FIREWALL_ID" ]; then
        fetch -qo /dev/null "${MANAGEMENT_SERVER}/command_result.php" \
            --post-data "firewall_id=${FIREWALL_ID}&command=firmware_update&status=${STATUS}&result=${RESULT}" 2>/dev/null
    fi
}

# Execute agent update
execute_agent_update() {
    log_message "Starting agent update..."
    
    # Download new agent
    NEW_AGENT="/tmp/opnsense_agent_new.sh"
    fetch -o "$NEW_AGENT" "${MANAGEMENT_SERVER}/opnsense_agent_v2.sh.txt" 2>/dev/null
    
    if [ -f "$NEW_AGENT" ]; then
        # Verify it's executable and has the right header
        if head -1 "$NEW_AGENT" | grep -q "#!/bin/bash"; then
            chmod +x "$NEW_AGENT"
            cp "$NEW_AGENT" "$SCRIPT_PATH"
            log_message "Agent updated successfully"
            
            # Report success
            if [ -n "$FIREWALL_ID" ]; then
                fetch -qo /dev/null "${MANAGEMENT_SERVER}/command_result.php" \
                    --post-data "firewall_id=${FIREWALL_ID}&command=agent_update&status=completed&result=Agent updated successfully" 2>/dev/null
            fi
        else
            log_message "Agent update failed: Invalid agent file"
        fi
        rm -f "$NEW_AGENT"
    else
        log_message "Agent update failed: Could not download new agent"
    fi
}

# Check-in function
checkin() {
    log_message "Starting check-in..."
    
    get_system_info
    
    log_message "Sending data: $JSON_DATA"
    
    # Send check-in data
    RESPONSE=$(fetch -qo - "${MANAGEMENT_SERVER}/agent_checkin.php" \
        --post-data "$JSON_DATA" 2>/dev/null)
    
    if [ $? -eq 0 ] && [ -n "$RESPONSE" ]; then
        log_message "Check-in successful: $RESPONSE"
        
        # Parse response to get firewall_id if we don't have one
        if [ -z "$FIREWALL_ID" ]; then
            FIREWALL_ID=$(echo "$RESPONSE" | grep -o '"firewall_id":"[^"]*"' | cut -d'"' -f4)
            if [ -n "$FIREWALL_ID" ]; then
                # Update config file
                sed -i '' "s/FIREWALL_ID=\".*\"/FIREWALL_ID=\"$FIREWALL_ID\"/" "$CONFIG_FILE" 2>/dev/null || \
                echo "FIREWALL_ID=\"$FIREWALL_ID\"" >> "$CONFIG_FILE"
                log_message "Updated firewall ID: $FIREWALL_ID"
            fi
        fi
        
        # Check for pending commands
        check_commands
        
        # Check if agent update is needed
        if echo "$RESPONSE" | grep -q "agent_update_available"; then
            execute_agent_update
        fi
    else
        log_message "Check-in failed"
    fi
}

# Main execution
case "${1:-checkin}" in
    "install")
        install_agent
        ;;
    "checkin")
        checkin
        ;;
    *)
        # If no argument, assume it's initial run and install
        if [ ! -f "$SCRIPT_PATH" ] || [ "$0" != "$SCRIPT_PATH" ]; then
            install_agent
        else
            checkin
        fi
        ;;
esac